@startuml
title Diagramme de SÃ©quence : Connexion (Email/Mot de passe + Google OAuth)

actor "Utilisateur" as User
participant "Frontend\n(Next.js)" as Frontend
participant "API Auth\n(Backend Express)" as Backend
participant "Google OAuth" as Google
database "MongoDB\n(Users)" as DB
participant "AuthProvider\n(localStorage)" as AuthProvider

== Connexion par Email/Mot de passe ==
User -> Frontend : Soumet le formulaire de connexion\n(email, mot de passe)
Frontend -> Backend : POST /api/auth/login\n{ email, password }
activate Backend
Backend -> DB : Chercher utilisateur par email
activate DB
DB --> Backend : Enregistrement utilisateur\n(avec mot de passe hashÃ©) / null
deactivate DB
alt Utilisateur trouvÃ© et mot de passe correct
  Backend -> Backend : VÃ©rifier mot de passe (bcrypt)
  Backend -> Backend : GÃ©nÃ©rer token JWT
  Backend --> Frontend : 200 OK\n{ token, user }
  deactivate Backend
  Frontend -> AuthProvider : Sauvegarder token et user\n(localStorage)
  Frontend -> User : Redirection vers "/" (tableau de bord)
else Identifiants invalides
  Backend --> Frontend : 401 Unauthorized\n{ message: "Identifiants invalides" }
  deactivate Backend
  Frontend -> User : Afficher alerte d'erreur\n"Identifiants invalides"
end

== Connexion via Google OAuth ==
User -> Frontend : Clic sur "Se connecter avec Google"
Frontend -> Google : Redirection vers consentement Google\n(GET /auth/google)
activate Google
Google --> User : Popup de connexion Google\n(choix du compte)
User -> Google : Choisir compte et accepter
Google --> Backend : Redirection callback avec code\n(/api/auth/google/callback?code=...)
deactivate Google
activate Backend
Backend -> Google : Ã‰changer code contre profil Google\n(id, email, nom, photo)
activate Google
Google --> Backend : Profil Google
deactivate Google
Backend -> DB : Chercher utilisateur par googleId ou email
activate DB
DB --> Backend : Enregistrement utilisateur / null
deactivate DB
alt Utilisateur existe
  Backend -> Backend : CrÃ©er token JWT
  Backend --> Frontend : Redirection vers callback frontend\navec token (/auth/callback?token=...)
  deactivate Backend
  Frontend -> AuthProvider : Sauvegarder token et user
  Frontend -> User : Redirection vers "/" (tableau de bord)
else Utilisateur NON trouvÃ©
  Backend --> Frontend : Redirection vers login avec erreur\n(/login?error=Aucun%20compte%20trouvÃ©...)
  deactivate Backend
  Frontend -> User : Afficher alerte d'erreur\n"âŒ Aucun compte trouvÃ© avec ce compte Google.\nğŸ‘‰ Veuillez vous inscrire d'abord..."
end

@enduml
