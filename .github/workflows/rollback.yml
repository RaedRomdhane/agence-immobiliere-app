name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - staging
          - production
      revision:
        description: 'Helm revision number to rollback to (leave empty for previous)'
        required: false
        type: string

jobs:
  rollback:
    name: Rollback to Previous Version
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          if [ "${{ inputs.environment }}" == "production" ]; then
            echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          else
            echo "${{ secrets.KUBECONFIG_STAGING }}" | base64 -d > $HOME/.kube/config
          fi
      
      - name: Show current revision
        run: |
          echo "Current Helm releases:"
          helm list -n ${{ inputs.environment }}
          echo ""
          echo "Release history:"
          helm history agence-immobiliere -n ${{ inputs.environment }}
      
      - name: Perform rollback
        run: |
          if [ -n "${{ inputs.revision }}" ]; then
            echo "Rolling back to revision ${{ inputs.revision }}"
            helm rollback agence-immobiliere ${{ inputs.revision }} -n ${{ inputs.environment }} --wait
          else
            echo "Rolling back to previous revision"
            helm rollback agence-immobiliere -n ${{ inputs.environment }} --wait
          fi
      
      - name: Verify rollback
        run: |
          kubectl rollout status deployment/agence-immobiliere-backend -n ${{ inputs.environment }} --timeout=5m
          kubectl rollout status deployment/agence-immobiliere-frontend -n ${{ inputs.environment }} --timeout=5m
          
          echo "Pods after rollback:"
          kubectl get pods -n ${{ inputs.environment }} -l app.kubernetes.io/name=agence-immobiliere
      
      - name: Run health check
        run: |
          sleep 20
          kubectl run rollback-health-check --image=curlimages/curl:latest --rm -i --restart=Never -n ${{ inputs.environment }} -- \
            curl -f http://agence-immobiliere-backend:5000/health || exit 1
      
      - name: Notify rollback completion
        run: |
          echo "Rollback completed successfully for ${{ inputs.environment }}"
          # Add notification here
