name: Staging Deployment (Vercel + Railway)

# D√©clencheurs - se d√©clenche apr√®s merge sur main
on:
  push:
    branches:
      - main
  workflow_dispatch:  # Permet d√©clenchement manuel

env:
  NODE_VERSION: '20.x'
  
jobs:
  # Job 1: Build et tests
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: üì¶ Installation Backend
        working-directory: ./backend
        run: npm ci

      - name: üß™ Tests Backend
        working-directory: ./backend
        run: npm run test:ci || echo "Tests skipped"

      - name: üì¶ Installation Frontend
        working-directory: ./frontend
        run: npm ci

      - name: üèóÔ∏è Build Frontend (v√©rification)
        working-directory: ./frontend
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.RAILWAY_BACKEND_URL }}
          NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${{ secrets.STAGING_GOOGLE_CLIENT_ID }}

  # Job 2: D√©ploiement Backend sur Railway
  deploy-backend:
    name: Deploy Backend to Railway
    runs-on: ubuntu-latest
    needs: build-and-test
    environment:
      name: staging-backend
      url: ${{ secrets.RAILWAY_BACKEND_URL }}
    
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4

      - name: üöÄ Deploy to Railway
        uses: bervProject/railway-deploy@main
        with:
          railway_token: ${{ secrets.RAILWAY_TOKEN }}
          service: backend

      - name: ‚è≥ Attendre le d√©ploiement
        run: sleep 30

      - name: üè• Health Check Backend
        run: |
          echo "üîç V√©rification du backend..."
          max_attempts=10
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.RAILWAY_BACKEND_URL }}/health || echo "000")
            
            if [ $response -eq 200 ]; then
              echo "‚úÖ Backend op√©rationnel (HTTP $response)"
              exit 0
            else
              attempt=$((attempt + 1))
              echo "‚è≥ Tentative $attempt/$max_attempts - Backend r√©pond HTTP $response"
              sleep 10
            fi
          done
          
          echo "‚ùå Backend ne r√©pond pas apr√®s $max_attempts tentatives"
          exit 1

  # Job 3: D√©ploiement Frontend sur Vercel
  deploy-frontend:
    name: Deploy Frontend to Vercel
    runs-on: ubuntu-latest
    needs: build-and-test
    environment:
      name: staging-frontend
      url: ${{ secrets.VERCEL_URL }}
    
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4

      - name: üöÄ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./frontend
          vercel-args: '--prod'
          
  # Job 4: Tests de sant√© post-d√©ploiement
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    
    steps:
      - name: üè• Health Check Backend
        run: |
          echo "üîç V√©rification finale du backend..."
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.RAILWAY_BACKEND_URL }}/health)
          
          if [ $response -eq 200 ]; then
            echo "‚úÖ Backend staging op√©rationnel (HTTP $response)"
          else
            echo "‚ùå Backend staging ne r√©pond pas correctement (HTTP $response)"
            exit 1
          fi

      - name: üè• Health Check Frontend
        run: |
          echo "üîç V√©rification du frontend..."
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.VERCEL_URL }})
          
          if [ $response -eq 200 ]; then
            echo "‚úÖ Frontend staging op√©rationnel (HTTP $response)"
          else
            echo "‚ùå Frontend staging ne r√©pond pas correctement (HTTP $response)"
            exit 1
          fi

      - name: üß™ Test API Endpoint
        run: |
          echo "üîç Test de l'endpoint /api..."
          response=$(curl -s ${{ secrets.RAILWAY_BACKEND_URL }}/api)
          echo "Response: $response"
          
          if echo "$response" | grep -q "version"; then
            echo "‚úÖ API r√©pond correctement"
          else
            echo "‚ö†Ô∏è API r√©pond mais format inattendu"
          fi

  # Job 5: Notification et tagging
  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend, health-check]
    if: always()
    
    steps:
      - name: üì• Checkout pour tagging
        uses: actions/checkout@v4
        if: needs.health-check.result == 'success'
        with:
          fetch-depth: 0

      - name: üè∑Ô∏è Create staging tag
        if: needs.health-check.result == 'success'
        run: |
          TAG="staging-$(date +'%Y%m%d-%H%M%S')"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a $TAG -m "Staging deployment: $TAG"
          git push origin $TAG
          echo "‚úÖ Tag cr√©√©: $TAG"
          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: üìä Cr√©er le r√©sum√© de d√©ploiement
        run: |
          echo "# üöÄ D√©ploiement Staging (Vercel + Railway)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üì¶ Statut du d√©ploiement" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend (Railway)**: ${{ needs.deploy-backend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend (Vercel)**: ${{ needs.deploy-frontend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Check**: ${{ needs.health-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üîó URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: ${{ secrets.RAILWAY_BACKEND_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: ${{ secrets.VERCEL_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Check**: ${{ secrets.RAILWAY_BACKEND_URL }}/health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ‚ÑπÔ∏è Informations" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Auteur**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ env.TAG }}" >> $GITHUB_STEP_SUMMARY

      - name: ‚úÖ D√©ploiement r√©ussi
        if: needs.health-check.result == 'success'
        run: |
          echo "üéâ D√©ploiement staging r√©ussi!"
          echo "‚úÖ Backend: ${{ secrets.RAILWAY_BACKEND_URL }}"
          echo "‚úÖ Frontend: ${{ secrets.VERCEL_URL }}"

      - name: ‚ùå D√©ploiement √©chou√©
        if: needs.health-check.result != 'success'
        run: |
          echo "‚ùå Le d√©ploiement staging a √©chou√©"
          echo "Consultez les logs pour plus de d√©tails"
          exit 1
