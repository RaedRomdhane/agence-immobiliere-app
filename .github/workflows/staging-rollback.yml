name: Rollback Staging

# Workflow manuel pour rollback vers une version prÃ©cÃ©dente
on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag de version Ã  dÃ©ployer (ex: staging-20250102-143000)'
        required: true
        type: string
      reason:
        description: 'Raison du rollback'
        required: false
        type: string
        default: 'Rollback manuel'

env:
  NODE_VERSION: '20.x'
  STAGING_URL: 'https://agence-immobiliere-staging.azurewebsites.net'

jobs:
  # Job 1: Validation du tag
  validate:
    name: Valider le tag
    runs-on: ubuntu-latest
    
    outputs:
      tag_exists: ${{ steps.check.outputs.exists }}
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” VÃ©rifier l'existence du tag
        id: check
        run: |
          if git rev-parse "${{ github.event.inputs.tag }}" >/dev/null 2>&1; then
            echo "âœ… Tag trouvÃ©: ${{ github.event.inputs.tag }}"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Tag non trouvÃ©: ${{ github.event.inputs.tag }}"
            echo "exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ğŸ“‹ Informations du tag
        run: |
          echo "ğŸ“Š Informations du rollback:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ github.event.inputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Raison**: ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "- **DÃ©clenchÃ© par**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“ Commit du tag:" >> $GITHUB_STEP_SUMMARY
          git show ${{ github.event.inputs.tag }} --no-patch >> $GITHUB_STEP_SUMMARY

  # Job 2: CrÃ©er un snapshot de l'Ã©tat actuel
  backup-current:
    name: Backup Ã‰tat Actuel
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: ğŸ“¥ Checkout du code actuel
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ CrÃ©er un tag de backup
        run: |
          BACKUP_TAG="staging-backup-$(date +'%Y%m%d-%H%M%S')"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a $BACKUP_TAG -m "Backup avant rollback vers ${{ github.event.inputs.tag }}"
          git push origin $BACKUP_TAG
          echo "âœ… Backup crÃ©Ã©: $BACKUP_TAG"
          echo "BACKUP_TAG=$BACKUP_TAG" >> $GITHUB_ENV

      - name: ğŸ“„ Sauvegarder les logs
        run: |
          echo "Backup effectuÃ© le $(date)" > backup-info.txt
          echo "Tag de backup: $BACKUP_TAG" >> backup-info.txt
          echo "Rollback vers: ${{ github.event.inputs.tag }}" >> backup-info.txt
          echo "Raison: ${{ github.event.inputs.reason }}" >> backup-info.txt

      - name: ğŸ“¤ Upload backup info
        uses: actions/upload-artifact@v4
        with:
          name: backup-info
          path: backup-info.txt
          retention-days: 90

  # Job 3: Rollback Backend
  rollback-backend:
    name: Rollback Backend
    runs-on: ubuntu-latest
    needs: backup-current
    environment:
      name: staging-backend
      url: ${{ env.STAGING_URL }}/health
    
    steps:
      - name: ğŸ“¥ Checkout du tag spÃ©cifiÃ©
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag }}
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Installation Backend
        working-directory: ./backend
        run: npm ci --production

      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ”„ Deploy version prÃ©cÃ©dente
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.STAGING_BACKEND_APP_NAME }}
          package: ./backend

      - name: â™»ï¸ Restart Backend
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az webapp restart --name ${{ secrets.STAGING_BACKEND_APP_NAME }} --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }}

      - name: â³ Attendre le redÃ©marrage
        run: sleep 30

  # Job 4: Rollback Frontend
  rollback-frontend:
    name: Rollback Frontend
    runs-on: ubuntu-latest
    needs: backup-current
    environment:
      name: staging-frontend
      url: ${{ secrets.STAGING_FRONTEND_URL }}
    
    steps:
      - name: ğŸ“¥ Checkout du tag spÃ©cifiÃ©
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag }}
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Installation Frontend
        working-directory: ./frontend
        run: npm ci

      - name: ğŸ—ï¸ Build Frontend
        working-directory: ./frontend
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.STAGING_API_URL }}
          NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${{ secrets.STAGING_GOOGLE_CLIENT_ID }}
          NODE_ENV: production

      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ”„ Deploy version prÃ©cÃ©dente
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.STAGING_STATIC_WEB_APP_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/frontend"
          output_location: ".next"
          skip_app_build: true

  # Job 5: VÃ©rification post-rollback
  verify-rollback:
    name: VÃ©rifier le Rollback
    runs-on: ubuntu-latest
    needs: [rollback-backend, rollback-frontend]
    
    steps:
      - name: â³ Attendre la stabilisation
        run: sleep 15

      - name: ğŸ¥ Health Check Backend
        run: |
          echo "ğŸ” VÃ©rification du backend aprÃ¨s rollback..."
          max_attempts=5
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            response=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.STAGING_URL }}/health)
            
            if [ $response -eq 200 ]; then
              echo "âœ… Backend opÃ©rationnel (HTTP $response)"
              break
            else
              attempt=$((attempt + 1))
              echo "â³ Tentative $attempt/$max_attempts - Backend rÃ©pond HTTP $response"
              sleep 10
            fi
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "âŒ Backend ne rÃ©pond pas aprÃ¨s $max_attempts tentatives"
            exit 1
          fi

      - name: ğŸ¥ Health Check Frontend
        run: |
          echo "ğŸ” VÃ©rification du frontend aprÃ¨s rollback..."
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.STAGING_FRONTEND_URL }})
          
          if [ $response -eq 200 ]; then
            echo "âœ… Frontend opÃ©rationnel (HTTP $response)"
          else
            echo "âŒ Frontend ne rÃ©pond pas correctement (HTTP $response)"
            exit 1
          fi

      - name: ğŸ§ª Test API
        run: |
          echo "ğŸ” Test de l'API aprÃ¨s rollback..."
          response=$(curl -s ${{ env.STAGING_URL }}/api)
          
          if echo "$response" | grep -q "version"; then
            echo "âœ… API rÃ©pond correctement"
          else
            echo "âš ï¸ API rÃ©pond mais format inattendu"
          fi

  # Job 6: Notification et documentation
  notify:
    name: Notification Rollback
    runs-on: ubuntu-latest
    needs: [backup-current, verify-rollback]
    if: always()
    
    steps:
      - name: ğŸ“¥ Download backup info
        uses: actions/download-artifact@v4
        with:
          name: backup-info
        continue-on-error: true

      - name: ğŸ“Š RÃ©sumÃ© du rollback
        run: |
          echo "# ğŸ”„ Rollback Staging EffectuÃ©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ DÃ©tails" >> $GITHUB_STEP_SUMMARY
          echo "- **Version dÃ©ployÃ©e**: ${{ github.event.inputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Raison**: ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "- **DÃ©clenchÃ© par**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… RÃ©sultats" >> $GITHUB_STEP_SUMMARY
          echo "- **Backup**: ${{ needs.backup-current.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Rollback Backend**: ${{ needs.rollback-backend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Rollback Frontend**: ${{ needs.rollback-frontend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **VÃ©rification**: ${{ needs.verify-rollback.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ”— URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: ${{ env.STAGING_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: ${{ secrets.STAGING_FRONTEND_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## â„¹ï¸ Information Backup" >> $GITHUB_STEP_SUMMARY
          if [ -f backup-info.txt ]; then
            cat backup-info.txt >> $GITHUB_STEP_SUMMARY
          fi

      - name: âœ… Rollback rÃ©ussi
        if: needs.verify-rollback.result == 'success'
        run: |
          echo "ğŸ‰ Rollback vers ${{ github.event.inputs.tag }} rÃ©ussi!"
          echo "âœ… L'application staging fonctionne correctement"

      - name: âŒ Rollback Ã©chouÃ©
        if: needs.verify-rollback.result != 'success'
        run: |
          echo "âŒ Le rollback a Ã©chouÃ©"
          echo "âš ï¸ Action manuelle requise"
          echo "ğŸ“‹ Consultez les logs pour plus de dÃ©tails"
          exit 1
