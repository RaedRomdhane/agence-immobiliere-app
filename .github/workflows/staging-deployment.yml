name: Staging Deployment

# DÃ©clencheurs - se dÃ©clenche aprÃ¨s merge sur main
on:
  push:
    branches:
      - main
  workflow_dispatch:  # Permet dÃ©clenchement manuel

# Variables d'environnement
env:
  NODE_VERSION: '20.x'
  STAGING_URL: 'https://agence-immobiliere-staging.azurewebsites.net'
  
jobs:
  # Job 1: Build et tests
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: ðŸ“¦ Installation Backend
        working-directory: ./backend
        run: npm ci

      - name: ðŸ“¦ Installation Frontend
        working-directory: ./frontend
        run: npm ci

      - name: ðŸ§ª Tests Backend
        working-directory: ./backend
        run: npm run test:ci

      - name: ðŸ—ï¸ Build Frontend
        working-directory: ./frontend
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.STAGING_API_URL }}
          NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${{ secrets.STAGING_GOOGLE_CLIENT_ID }}

      - name: ðŸ“¤ Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: |
            backend/
            !backend/node_modules/
            !backend/coverage/
            !backend/.env
          retention-days: 1

      - name: ðŸ“¤ Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: |
            frontend/.next/
            frontend/public/
            frontend/package*.json
          retention-days: 1

  # Job 2: DÃ©ploiement Backend sur Staging
  deploy-backend-staging:
    name: Deploy Backend to Staging
    runs-on: ubuntu-latest
    needs: build-and-test
    environment:
      name: staging-backend
      url: ${{ env.STAGING_URL }}/health
    
    steps:
      - name: ðŸ“¥ Download Backend Artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: ./backend

      - name: ðŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸš€ Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.STAGING_BACKEND_APP_NAME }}
          package: ./backend

      - name: ðŸ”§ Configure App Settings
        uses: azure/appservice-settings@v1
        with:
          app-name: ${{ secrets.STAGING_BACKEND_APP_NAME }}
          app-settings-json: |
            [
              {
                "name": "NODE_ENV",
                "value": "staging",
                "slotSetting": false
              },
              {
                "name": "MONGODB_URI",
                "value": "${{ secrets.STAGING_MONGODB_URI }}",
                "slotSetting": false
              },
              {
                "name": "JWT_SECRET",
                "value": "${{ secrets.STAGING_JWT_SECRET }}",
                "slotSetting": false
              },
              {
                "name": "SESSION_SECRET",
                "value": "${{ secrets.STAGING_SESSION_SECRET }}",
                "slotSetting": false
              },
              {
                "name": "GOOGLE_CLIENT_ID",
                "value": "${{ secrets.STAGING_GOOGLE_CLIENT_ID }}",
                "slotSetting": false
              },
              {
                "name": "GOOGLE_CLIENT_SECRET",
                "value": "${{ secrets.STAGING_GOOGLE_CLIENT_SECRET }}",
                "slotSetting": false
              },
              {
                "name": "FRONTEND_URL",
                "value": "${{ secrets.STAGING_FRONTEND_URL }}",
                "slotSetting": false
              }
            ]

      - name: ðŸ—„ï¸ Run Database Migrations
        run: |
          echo "ðŸ—„ï¸ ExÃ©cution des migrations de base de donnÃ©es..."
          # Si vous avez des scripts de migration, les exÃ©cuter ici
          # npm run migrate --prefix ./backend
          echo "âœ… Migrations terminÃ©es"

      - name: â™»ï¸ Restart App Service
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az webapp restart --name ${{ secrets.STAGING_BACKEND_APP_NAME }} --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }}

  # Job 3: DÃ©ploiement Frontend sur Staging
  deploy-frontend-staging:
    name: Deploy Frontend to Staging
    runs-on: ubuntu-latest
    needs: build-and-test
    environment:
      name: staging-frontend
      url: ${{ secrets.STAGING_FRONTEND_URL }}
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Installation Frontend
        working-directory: ./frontend
        run: npm ci

      - name: ðŸ—ï¸ Build Frontend with Staging Config
        working-directory: ./frontend
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.STAGING_API_URL }}
          NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${{ secrets.STAGING_GOOGLE_CLIENT_ID }}
          NODE_ENV: production

      - name: ðŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸš€ Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.STAGING_STATIC_WEB_APP_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/frontend"
          output_location: ".next"
          skip_app_build: true

  # Job 4: Tests de santÃ© post-dÃ©ploiement
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [deploy-backend-staging, deploy-frontend-staging]
    
    steps:
      - name: ðŸ¥ Health Check Backend
        run: |
          echo "ðŸ” VÃ©rification du backend staging..."
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.STAGING_URL }}/health)
          
          if [ $response -eq 200 ]; then
            echo "âœ… Backend staging opÃ©rationnel (HTTP $response)"
          else
            echo "âŒ Backend staging ne rÃ©pond pas correctement (HTTP $response)"
            exit 1
          fi

      - name: ðŸ¥ Health Check Frontend
        run: |
          echo "ðŸ” VÃ©rification du frontend staging..."
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.STAGING_FRONTEND_URL }})
          
          if [ $response -eq 200 ]; then
            echo "âœ… Frontend staging opÃ©rationnel (HTTP $response)"
          else
            echo "âŒ Frontend staging ne rÃ©pond pas correctement (HTTP $response)"
            exit 1
          fi

      - name: ðŸ§ª Test API Endpoint
        run: |
          echo "ðŸ” Test de l'endpoint /api..."
          response=$(curl -s ${{ env.STAGING_URL }}/api)
          echo "Response: $response"
          
          if echo "$response" | grep -q "version"; then
            echo "âœ… API rÃ©pond correctement"
          else
            echo "âŒ API ne rÃ©pond pas comme attendu"
            exit 1
          fi

  # Job 5: Notification de dÃ©ploiement
  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [deploy-backend-staging, deploy-frontend-staging, health-check]
    if: always()
    
    steps:
      - name: ðŸ“Š CrÃ©er le rÃ©sumÃ© de dÃ©ploiement
        run: |
          echo "# ðŸš€ DÃ©ploiement Staging" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ DÃ©ploiement rÃ©alisÃ©" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: ${{ needs.deploy-backend-staging.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: ${{ needs.deploy-frontend-staging.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Check**: ${{ needs.health-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”— URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: ${{ env.STAGING_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: ${{ secrets.STAGING_FRONTEND_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Health**: ${{ env.STAGING_URL }}/health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## â„¹ï¸ Informations" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Auteur**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branche**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY

      - name: âœ… DÃ©ploiement rÃ©ussi
        if: needs.health-check.result == 'success'
        run: |
          echo "ðŸŽ‰ DÃ©ploiement staging rÃ©ussi!"
          echo "âœ… Backend: ${{ env.STAGING_URL }}"
          echo "âœ… Frontend: ${{ secrets.STAGING_FRONTEND_URL }}"

      - name: âŒ DÃ©ploiement Ã©chouÃ©
        if: needs.health-check.result != 'success'
        run: |
          echo "âŒ Le dÃ©ploiement staging a Ã©chouÃ©"
          echo "Consultez les logs pour plus de dÃ©tails"
          exit 1

  # Job 6: Tag de version
  tag-version:
    name: Tag Version
    runs-on: ubuntu-latest
    needs: health-check
    if: needs.health-check.result == 'success'
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ·ï¸ Create staging tag
        run: |
          TAG="staging-$(date +'%Y%m%d-%H%M%S')"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a $TAG -m "Staging deployment: $TAG"
          git push origin $TAG
          echo "âœ… Tag crÃ©Ã©: $TAG"
          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: ðŸ“ Create Release Notes
        run: |
          echo "# ðŸ“‹ Notes de version: ${{ env.TAG }}" >> release-notes.md
          echo "" >> release-notes.md
          echo "DÃ©ployÃ© en staging le $(date +'%Y-%m-%d Ã  %H:%M:%S')" >> release-notes.md
          echo "" >> release-notes.md
          echo "## Commits inclus:" >> release-notes.md
          git log --oneline -10 >> release-notes.md
